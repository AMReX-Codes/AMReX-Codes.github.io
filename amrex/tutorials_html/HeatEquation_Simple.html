<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tutorial: Heat Equation - Simple &mdash; amrex 22.09-dev documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="_static/doctools.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> amrex
          </a>
              <div class="version">
                22.09-dev
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="GuidedTutorials.html">Guided Tutorials</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="AMR_Tutorial.html">Amr</a></li>
<li class="toctree-l1"><a class="reference internal" href="Basic_Tutorial.html">Basic</a></li>
<li class="toctree-l1"><a class="reference internal" href="Blueprint_Tutorial.html">Blueprint</a></li>
<li class="toctree-l1"><a class="reference internal" href="EB_Tutorial.html">EB</a></li>
<li class="toctree-l1"><a class="reference internal" href="ForkJoin_Tutorial.html">Forkjoin</a></li>
<li class="toctree-l1"><a class="reference internal" href="GPU_Tutorial.html">GPU</a></li>
<li class="toctree-l1"><a class="reference internal" href="LinearSolvers_Tutorial.html">LinearSolvers</a></li>
<li class="toctree-l1"><a class="reference internal" href="ML_Tutorial.html">ML/PYTORCH</a></li>
<li class="toctree-l1"><a class="reference internal" href="MUI_Tutorial.html">MUI</a></li>
<li class="toctree-l1"><a class="reference internal" href="Particles_Tutorial.html">Particles</a></li>
<li class="toctree-l1"><a class="reference internal" href="SDC_Tutorial.html">SDC</a></li>
<li class="toctree-l1"><a class="reference internal" href="SENSEI_Tutorial.html">SENSEI</a></li>
<li class="toctree-l1"><a class="reference internal" href="SUNDIALS_Tutorial.html">SUNDIALS and Time Integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="SWFFT_Tutorial.html">SWFFT</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">amrex</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Tutorial: Heat Equation - Simple</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/HeatEquation_Simple.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="tutorial-heat-equation-simple">
<span id="guided-heat-simple"></span><h1>Tutorial: Heat Equation - Simple<a class="headerlink" href="#tutorial-heat-equation-simple" title="Permalink to this heading"></a></h1>
<div class="warning admonition">
<p class="admonition-title"><strong>Time to Complete</strong>: 25 mins</p>
<dl class="simple">
<dt><strong>GOALS:</strong></dt><dd><ul class="simple">
<li><p>Compile an AMReX Code</p></li>
<li><p>Introduce Basic AMReX Elements</p></li>
<li><p>Generate and Visualize Output</p></li>
</ul>
</dd>
</dl>
</div>
<p>In this tutorial we take the steps needed to go from source download to
visualized output of an AMReX code. We will demonstrate basic building,
compiling and output generation. We will also examine several key AMReX features
in a C++ code and plot the output with Python in a Jupyter notebook.</p>
<section id="setting-up-your-environment">
<h2>Setting Up Your Environment<a class="headerlink" href="#setting-up-your-environment" title="Permalink to this heading"></a></h2>
<p>This tutorial recommends using Gitpod (Requires a GitHub account).  Gitpod
provides an online terminal that is already preconfigured for our development
environment.</p>
<blockquote>
<div><p>Click <a href="https://gitpod.io/#https://github.com/AMReX-Codes/amrex-tutorials" target="_blank">here</a> to be taken to the Gitpod workspace.</p>
</div></blockquote>
</section>
<section id="building-the-project">
<h2>Building the Project<a class="headerlink" href="#building-the-project" title="Permalink to this heading"></a></h2>
<p>This example will use CMake to build the project. Navigate to the directory
<code class="code docutils literal notranslate"><span class="pre">/workspace/amrex-tutorials/GuidedTutorials/HeatEquation_Simple/</span></code>
and type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="n">Build</span>
<span class="n">cd</span> <span class="n">Build</span>
<span class="n">cmake</span> <span class="o">..</span>
</pre></div>
</div>
<p>This will create a build folder and run CMake to setup the build configuration.
During this process CMake will read the <code class="docutils literal notranslate"><span class="pre">CmakeLists.txt</span></code> file in the subdirectory
to generate and download, if necessary, the the build files it
needs to compile the tutorial in the next step.</p>
<p>More information about building options, such as disabling MPI, can be found at
<a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/BuildingAMReX_Chapter.html">https://amrex-codes.github.io/amrex/docs_html/BuildingAMReX_Chapter.html</a>.</p>
</section>
<section id="compiling-the-code-with-cmake">
<h2>Compiling the Code with CMake<a class="headerlink" href="#compiling-the-code-with-cmake" title="Permalink to this heading"></a></h2>
<p>After building the project, in the <code class="docutils literal notranslate"><span class="pre">Build</span></code> directory you will find several new
files and directories created by CMake during the configuration process.
At the prompt type</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cmake</span> <span class="o">--</span><span class="n">build</span> <span class="o">.</span> <span class="o">-</span><span class="n">j2</span>
</pre></div>
</div>
<p>CMake will then compile the code and dependencies. The <code class="docutils literal notranslate"><span class="pre">-j2</span></code> flag tells CMake
to use 2 processes to speed up compilation. The first time you call <code class="code docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">--build</span> <span class="pre">.</span></code>
you should see a list of all the source AMReX files being compiled:</p>
<img alt="_images/Cmake_make.png" src="_images/Cmake_make.png" />
<div class="line-block">
<div class="line"><br /></div>
</div>
<p>When CMake finishes you will be left with an executable named <code class="code docutils literal notranslate"><span class="pre">HeatEquation_Simple</span></code>.
To run the code type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">./</span><span class="n">HeatEquation_Simple</span> <span class="n">inputs</span>
</pre></div>
</div>
<p>This command will run the <code class="code docutils literal notranslate"><span class="pre">HeatEquation_Simple</span></code> code with the <code class="code docutils literal notranslate"><span class="pre">inputs</span></code> file as
the input parameters. Parsing of the information in the <code class="code docutils literal notranslate"><span class="pre">inputs</span></code> file is done by
<code class="code docutils literal notranslate"><span class="pre">ParmParse</span></code>. More details can be found at
<a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/Basics.html#parmparse">https://amrex-codes.github.io/amrex/docs_html/Basics.html#parmparse</a></p>
</section>
<section id="code-highlights">
<h2>Code Highlights<a class="headerlink" href="#code-highlights" title="Permalink to this heading"></a></h2>
<p>At this point we have built, compiled and ran the <code class="code docutils literal notranslate"><span class="pre">HeatEquation_Simple</span></code> code. Now
we will walk through the code and explain some essential features of AMReX syntax.</p>
<section id="basic-structure">
<h3>Basic Structure<a class="headerlink" href="#basic-structure" title="Permalink to this heading"></a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Main
 ├──── Initialize AMReX
 ├──── Declare Simulation Parameters
 ├──── Read Parameter Values From Input File
 ├──── Define Simulation Setup &amp; Geometry
 ├──── Initialize Data Loop
 │     └──── Set Values For Each Cell
 ├──── Write Initial Plotfile
 ├──── Main Time Evolution Loop
 │     ├──── Evolve Values For Each Cell
 │     ├──── Increment
 │     └──── Write Plotfile At Given Interval
 └──── Finalize AMReX
</pre></div>
</div>
</section>
<section id="amrex-namespace-and-required-commands">
<h3>AMReX Namespace and Required Commands<a class="headerlink" href="#amrex-namespace-and-required-commands" title="Permalink to this heading"></a></h3>
<p>The AMReX namespace contains many useful features. They are accessed by including
the necessary header files and using the
prefix <code class="code docutils literal notranslate"><span class="pre">amrex::</span></code>. Each
<code class="code docutils literal notranslate"><span class="pre">int</span> <span class="pre">main(...)</span></code> using AMReX should begin with <code class="code docutils literal notranslate"><span class="pre">amrex::Initialize()</span></code>
immediately followed by <code class="code docutils literal notranslate"><span class="pre">{</span></code>
and end with <code class="code docutils literal notranslate"><span class="pre">}</span></code> immediately followed by <code class="code docutils literal notranslate"><span class="pre">amrex::Finalize()</span></code>. Together
these commands are responsible for
initializing the AMReX execution environment and proper release of resources. AMReX
classes and features not located between the commands will not function properly.</p>
<p>Other useful features include
<code class="code docutils literal notranslate"><span class="pre">amrex::Print()</span></code> which was written to handle print output during parallel
execution.</p>
</section>
<section id="the-multifab-data-structure">
<h3>The MultiFab Data Structure<a class="headerlink" href="#the-multifab-data-structure" title="Permalink to this heading"></a></h3>
<p>A <code class="code docutils literal notranslate"><span class="pre">MultiFab</span></code> is a data structure that AMReX can
distribute among parallel processes. In this Heat Equation example
we use two MultiFabs to hold the current and previous values of <span class="math notranslate nohighlight">\(\phi\)</span>
as defined <a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/GettingStarted.html#example-heat-equation-solver">here</a>.</p>
<p>The declaration of the first MultiFab for the previous values of <span class="math notranslate nohighlight">\(\phi\)</span> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">amrex</span><span class="p">::</span><span class="n">MultiFab</span> <span class="n">phi_old</span><span class="p">(</span><span class="n">ba</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">Ncomp</span><span class="p">,</span> <span class="n">Nghost</span><span class="p">);</span>
</pre></div>
</div>
<p>Here <code class="code docutils literal notranslate"><span class="pre">ba</span></code> is a <a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/Basics.html#boxarray">BoxArray</a> that stores a collection of boxes
on a single level of mesh refinement. <code class="code docutils literal notranslate"><span class="pre">dm</span></code> is a <a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/Basics.html#distributionmapping">DistributionMapping</a>
that describes how to distribute processing across multiple CPUs and threads.
<code class="code docutils literal notranslate"><span class="pre">Ncomp</span></code> is the number of values stored for each cell of the mesh; in this case, 1
for the scalar <span class="math notranslate nohighlight">\(\phi\)</span>. The value for <code class="code docutils literal notranslate"><span class="pre">Nghost</span></code> tells AMReX
how many <a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/Basics.html#ghost-cells">ghost cells</a> to create outside the box’s valid region.</p>
</section>
<section id="mfiter-and-parallelfor">
<h3>MFIter and ParallelFor<a class="headerlink" href="#mfiter-and-parallelfor" title="Permalink to this heading"></a></h3>
<p>Now we will examine the main time evolution loop. In this section AMReX’s <code class="code docutils literal notranslate"><span class="pre">MFIter</span></code> and
<code class="code docutils literal notranslate"><span class="pre">ParallelFor</span></code> constructs work in conjunction to provide efficient parallel execution.
The code where this happens is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">step</span> <span class="o">&lt;=</span> <span class="n">nsteps</span><span class="p">;</span> <span class="o">++</span><span class="n">step</span><span class="p">){</span>

     <span class="n">phi_old</span><span class="o">.</span><span class="n">FillBoundary</span><span class="p">(</span><span class="n">geom</span><span class="o">.</span><span class="n">periodicity</span><span class="p">());</span>

     <span class="k">for</span> <span class="p">(</span> <span class="n">amrex</span><span class="p">::</span><span class="n">MFIter</span> <span class="n">mfi</span><span class="p">(</span><span class="n">phi_old</span><span class="p">);</span> <span class="n">mfi</span><span class="o">.</span><span class="n">isValid</span><span class="p">();</span> <span class="o">++</span><span class="n">mfi</span> <span class="p">){</span>

         <span class="n">const</span> <span class="n">amrex</span><span class="p">::</span><span class="n">Box</span><span class="o">&amp;</span> <span class="n">bx</span> <span class="o">=</span> <span class="n">mfi</span><span class="o">.</span><span class="n">validbox</span><span class="p">();</span>

         <span class="n">const</span> <span class="n">amrex</span><span class="p">::</span><span class="n">Array4</span><span class="o">&lt;</span><span class="n">amrex</span><span class="p">::</span><span class="n">Real</span><span class="o">&gt;&amp;</span> <span class="n">phiOld</span> <span class="o">=</span> <span class="n">phi_old</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mfi</span><span class="p">);</span>
         <span class="n">const</span> <span class="n">amrex</span><span class="p">::</span><span class="n">Array4</span><span class="o">&lt;</span><span class="n">amrex</span><span class="p">::</span><span class="n">Real</span><span class="o">&gt;&amp;</span> <span class="n">phiNew</span> <span class="o">=</span> <span class="n">phi_new</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mfi</span><span class="p">);</span>

         <span class="n">amrex</span><span class="p">::</span><span class="n">ParallelFor</span><span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="n">AMREX_GPU_DEVICE</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="nb">int</span> <span class="n">j</span><span class="p">,</span> <span class="nb">int</span> <span class="n">k</span><span class="p">){</span>

             <span class="n">phiNew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span>
                 <span class="p">(</span> <span class="p">(</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                  <span class="o">+</span><span class="p">(</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                  <span class="o">+</span><span class="p">(</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">);</span>

         <span class="p">});</span> <span class="o">//</span> <span class="n">end</span> <span class="n">ParallelFor</span>
     <span class="p">}</span>

     <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">+</span> <span class="n">dt</span><span class="p">;</span>
     <span class="n">amrex</span><span class="p">::</span><span class="n">MultiFab</span><span class="p">::</span><span class="n">Copy</span><span class="p">(</span><span class="n">phi_old</span><span class="p">,</span> <span class="n">phi_new</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
     <span class="n">amrex</span><span class="p">::</span><span class="n">Print</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;Advanced step &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">step</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">;</span>

     <span class="k">if</span> <span class="p">(</span><span class="n">plot_int</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">step</span><span class="o">%</span><span class="n">plot_int</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span>
         <span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">pltfile</span> <span class="o">=</span> <span class="n">amrex</span><span class="p">::</span><span class="n">Concatenate</span><span class="p">(</span><span class="s2">&quot;plt&quot;</span><span class="p">,</span><span class="n">step</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
         <span class="n">WriteSingleLevelPlotfile</span><span class="p">(</span><span class="n">pltfile</span><span class="p">,</span> <span class="n">phi_new</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phi&quot;</span><span class="p">},</span> <span class="n">geom</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>
     <span class="p">}</span>
 <span class="p">}</span>
</pre></div>
</div>
<p>First note the outer <code class="code docutils literal notranslate"><span class="pre">for</span></code> loop that counts the time step in our simulation. At each step
we begin by calling <code class="code docutils literal notranslate"><span class="pre">phi_old.FillBoundary(geom.periodicity())</span></code>. This fills ghost cells
based on the previous state of <span class="math notranslate nohighlight">\(\phi\)</span> with periodic boundary conditions.</p>
<section id="mfiter">
<h4>MFIter<a class="headerlink" href="#mfiter" title="Permalink to this heading"></a></h4>
<p>The next <code class="code docutils literal notranslate"><span class="pre">for</span></code> loop,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="p">(</span> <span class="n">amrex</span><span class="p">::</span><span class="n">MFIter</span> <span class="n">mfi</span><span class="p">(</span><span class="n">phi_old</span><span class="p">);</span> <span class="n">mfi</span><span class="o">.</span><span class="n">isValid</span><span class="p">();</span> <span class="o">++</span><span class="n">mfi</span> <span class="p">)</span>
</pre></div>
</div>
<p>uses the data object <code class="code docutils literal notranslate"><span class="pre">MFIter</span></code> to separate the mesh across processes for individual operations. Within this loop
the active piece of the mesh is defined by <code class="code docutils literal notranslate"><span class="pre">mfi.validbox()</span></code> and is accessed via <code class="code docutils literal notranslate"><span class="pre">bx</span></code> on the line,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">amrex</span><span class="p">::</span><span class="n">Box</span><span class="o">&amp;</span> <span class="n">bx</span> <span class="o">=</span> <span class="n">mfi</span><span class="o">.</span><span class="n">validbox</span><span class="p">();</span>
</pre></div>
</div>
<p>In the next lines, the part of <code class="code docutils literal notranslate"><span class="pre">MultiFab</span></code> data that pertains to the current active
piece of the mesh is converted to an <a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/Basics.html?highlight=array4#basefab-farraybox-iarraybox-and-array4">Array4</a> data type for i,j,k access:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">amrex</span><span class="p">::</span><span class="n">Array4</span><span class="o">&lt;</span><span class="n">amrex</span><span class="p">::</span><span class="n">Real</span><span class="o">&gt;&amp;</span> <span class="n">phiOld</span> <span class="o">=</span> <span class="n">phi_old</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mfi</span><span class="p">);</span>
<span class="n">const</span> <span class="n">amrex</span><span class="p">::</span><span class="n">Array4</span><span class="o">&lt;</span><span class="n">amrex</span><span class="p">::</span><span class="n">Real</span><span class="o">&gt;&amp;</span> <span class="n">phiNew</span> <span class="o">=</span> <span class="n">phi_new</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mfi</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="parallelfor">
<h4>ParallelFor<a class="headerlink" href="#parallelfor" title="Permalink to this heading"></a></h4>
<p><code class="code docutils literal notranslate"><span class="pre">ParallelFor</span></code> provides parallel execution of i,j,k operations that would otherwise require
three nested loops. This AMReX construct automatically adapts for efficient computation
based on the available hardware, including CPU and CPU+GPU variations.
In this example, it is here we compute the
forward Euler step (see <a class="reference external" href="https://amrex-codes.github.io/amrex/docs_html/GettingStarted.html#example-heat-equation-solver">Heat Eqn</a>) with the code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">amrex</span><span class="p">::</span><span class="n">ParallelFor</span><span class="p">(</span><span class="n">bx</span><span class="p">,</span> <span class="p">[</span><span class="o">=</span><span class="p">]</span> <span class="n">AMREX_GPU_DEVICE</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="nb">int</span> <span class="n">j</span><span class="p">,</span> <span class="nb">int</span> <span class="n">k</span><span class="p">){</span>

<span class="n">phiNew</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">=</span> <span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">dt</span> <span class="o">*</span>
   <span class="p">(</span> <span class="p">(</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
   <span class="o">+</span><span class="p">(</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">k</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
   <span class="o">+</span><span class="p">(</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="n">phiOld</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">dx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dx</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">);</span>

<span class="p">});</span> <span class="o">//</span> <span class="n">end</span> <span class="n">ParallelFor</span>
</pre></div>
</div>
<p>The rest of the code in the main time evolution loop updates the time and
<code class="code docutils literal notranslate"><span class="pre">MultiFab</span></code> data, prints a status update to terminal, and writes
output to a plot file that will be used for visualization.</p>
</section>
</section>
</section>
<section id="visualizing-output">
<h2>Visualizing Output<a class="headerlink" href="#visualizing-output" title="Permalink to this heading"></a></h2>
<section id="data-files">
<h3>Data Files<a class="headerlink" href="#data-files" title="Permalink to this heading"></a></h3>
<p>In <code class="code docutils literal notranslate"><span class="pre">main.cpp</span></code> we called a plot function in two places. The
first time was to plot initial data.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">129</span>     <span class="k">if</span> <span class="p">(</span><span class="n">plot_int</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">130</span>     <span class="p">{</span>
<span class="mi">131</span>         <span class="nb">int</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">132</span>         <span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">pltfile</span> <span class="o">=</span> <span class="n">amrex</span><span class="p">::</span><span class="n">Concatenate</span><span class="p">(</span><span class="s2">&quot;plt&quot;</span><span class="p">,</span><span class="n">step</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
<span class="mi">133</span>         <span class="n">WriteSingleLevelPlotfile</span><span class="p">(</span><span class="n">pltfile</span><span class="p">,</span> <span class="n">phi_old</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phi&quot;</span><span class="p">},</span> <span class="n">geom</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="mi">134</span>     <span class="p">}</span>
</pre></div>
</div>
<p>The second time plots were generated at given intervals during
the main time progression loop.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">171</span>         <span class="k">if</span> <span class="p">(</span><span class="n">plot_int</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">step</span><span class="o">%</span><span class="n">plot_int</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="mi">172</span>         <span class="p">{</span>
<span class="mi">173</span>             <span class="n">const</span> <span class="n">std</span><span class="p">::</span><span class="n">string</span><span class="o">&amp;</span> <span class="n">pltfile</span> <span class="o">=</span> <span class="n">amrex</span><span class="p">::</span><span class="n">Concatenate</span><span class="p">(</span><span class="s2">&quot;plt&quot;</span><span class="p">,</span><span class="n">step</span><span class="p">,</span><span class="mi">5</span><span class="p">);</span>
<span class="mi">174</span>             <span class="n">WriteSingleLevelPlotfile</span><span class="p">(</span><span class="n">pltfile</span><span class="p">,</span> <span class="n">phi_new</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;phi&quot;</span><span class="p">},</span> <span class="n">geom</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">step</span><span class="p">);</span>
<span class="mi">175</span>         <span class="p">}</span>
</pre></div>
</div>
<p>Each time we run the code it will create a series of directories which contain
data for visualization. Now run <code class="code docutils literal notranslate"><span class="pre">HeatEquation_Simple</span></code> with the <code class="code docutils literal notranslate"><span class="pre">inputs</span></code>
file. After it finishes your directory should look like this.</p>
<img alt="_images/plot_dirs.png" src="_images/plot_dirs.png" />
</section>
<section id="visualization-in-jupyter">
<h3>Visualization in Jupyter<a class="headerlink" href="#visualization-in-jupyter" title="Permalink to this heading"></a></h3>
<p>We will use Python and the yt package in a Jupyter notebook to generate plots for the data
in the directories created in the previous step. First launch the Jupyter notebook
with the command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jupyter</span> <span class="n">notebook</span>
</pre></div>
</div>
<p>When Jupyter starts, it will generate a token at the command line
and ask for a password in the window it opened. Copy the token
to enter to the notebook.</p>
<img alt="_images/token_hl.png" src="_images/token_hl.png" />
<p>Once the notebook starts, find <code class="code docutils literal notranslate"><span class="pre">Visualization.ipynb</span></code> and open it.
In this file there are additional notes about the
heat equation example, followed by several cells that use <code class="code docutils literal notranslate"><span class="pre">yt</span></code>
commands to read AMReX output files.</p>
</section>
<section id="yt">
<h3>yt<a class="headerlink" href="#yt" title="Permalink to this heading"></a></h3>
<p>The following commands import the <code class="code docutils literal notranslate"><span class="pre">yt</span></code> package and plot
a 2D slice of the output at from the 1000th time step.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">yt</span>
<span class="kn">from</span> <span class="nn">yt.frontends.boxlib.data_structures</span> <span class="k">import</span> <span class="n">AMReXDataset</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">AMReXDataset</span><span class="p">(</span><span class="s2">&quot;plt01000&quot;</span><span class="p">)</span>
<span class="n">sl</span> <span class="o">=</span> <span class="n">yt</span><span class="o">.</span><span class="n">SlicePlot</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;boxlib&#39;</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">))</span>
<span class="n">sl</span>
</pre></div>
</div>
<p>In our example, the commands are already written in the notebook.
To run them, select from the menu: <cite>Kernel -&gt; Restart &amp; Run All</cite>.
Once the run is complete, you will get the following plot.</p>
<img alt="_images/heat_eq_plot.png" src="_images/heat_eq_plot.png" />
</section>
</section>
<section id="what-s-next">
<h2>What’s Next?<a class="headerlink" href="#what-s-next" title="Permalink to this heading"></a></h2>
<p>The code in this example was simplified down to a single file. Other convenient features
that require more complex syntax were removed for the sake of a
straight-forward presentation. In the next example
we’ll put these pieces back and write code like an AMReX developer.</p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2018, AMReX Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>